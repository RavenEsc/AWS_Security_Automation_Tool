name: ci

on:
  push:
    branches:
      - 'main'

jobs:
  Docker:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - 
        name: Checkout
        uses: actions/checkout@v2
      - 
        name: Configure AWS credentials from Test account
        uses: aws-actions/configure-aws-credentials@master
        with:
          role-to-assume: arn:aws:iam::464004139021:role/GithubActionsRole
          aws-region: us-east-1

      # - 
      #   name: Create and Display ECR Repo
      #   run: aws ecr create-repository --repoistory-name ???

      - 
        name: Login to Amazon ECR
        id: login-ecr
        
        uses: aws-actions/amazon-ecr-login@v1
        with:
          mask-password: true

      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - 
        name: Build, tag and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE: oooooooo
          TAG: latest
        run: |
          docker buildx build -t $ECR_REGISTRY/$IMAGE:$TAG ../code/discordlambda/ -f Dockerfile
          docker push $ECR_REGISTRY/$IMAGE:$TAG
    #   -
    #     name: Login to Docker Hub
    #     uses: docker/login-action@v3
    #     with:
    #       username: ${{ secrets.DOCKERHUB_USERNAME }}
    #       password: ${{ secrets.DOCKERHUB_TOKEN }}

    #   -
    #     name: Build and push
    #     uses: docker/build-push-action@v5
    #     with:
    #       push: true
    #       tags: user/app:latest